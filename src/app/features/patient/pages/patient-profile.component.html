<div class="card shadow-sm border-0">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-soft-purple rounded-pill">MyDoc</span>
      <h5 class="mb-0 fw-bold text-purple">My Profile</h5>
    </div>

    <div class="d-flex gap-2">
      <!-- Change Password Button -->
      <button class="btn btn-outline-purple btn-sm d-flex align-items-center" (click)="togglePwdPanel()">
        <span class="material-icons me-1"></span>
        <span>{{ showPwdPanel ? 'Close' : 'Change Password' }}</span>
      </button>

      <!-- Edit Button -->
      <button *ngIf="!editing" class="btn btn-primary btn-sm d-flex align-items-center" (click)="startEdit()">
        <span class="material-icons me-1"></span>
        <span>Edit</span>
      </button>
    </div>
  </div>

  <div class="card-body">
    <!-- Loading -->
    <div *ngIf="loading && !errorMsg" class="text-center py-4">
      <div class="spinner-border text-purple"></div>
      <p class="mt-2">Loading profile...</p>
    </div>

    <!-- Error -->
    <div *ngIf="!loading && errorMsg" class="alert alert-danger">{{ errorMsg }}</div>

    <!-- View Mode -->
    <div *ngIf="!loading && profile && !editing" class="row g-4 fade-in">
      <div class="col-md-6">
        <p><strong>Name:</strong> {{ profile.name }}</p>
        <p><strong>Email:</strong> {{ profile.email }}</p>
        <p><strong>Phone:</strong> {{ profile.phone }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Date of Birth:</strong> {{ profile.dob | date }}</p>
        <p><strong>Gender:</strong> {{ profile.gender }}</p>
        <p><strong>Address:</strong> {{ profile.address }}</p>
      </div>
    </div>

    <!-- Edit Mode -->
    <form *ngIf="!loading && editing" [formGroup]="form" (ngSubmit)="save()" class="row g-3 fade-in">
      <div class="col-md-6">
        <label class="form-label">Name</label>
        <input formControlName="name" class="form-control" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input type="email" formControlName="email" class="form-control" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Phone <small class="text-muted">(10 digits)</small></label>
        <input formControlName="phone" class="form-control" maxlength="10" />
        <small class="text-danger" *ngIf="form.get('phone')?.invalid && form.get('phone')?.touched">
          Phone must be 10 digits.
        </small>
      </div>

      <div class="col-md-6">
        <label class="form-label">Date of Birth</label>
        <input type="date" formControlName="dob" class="form-control" [max]="today" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Gender</label>
        <select formControlName="gender" class="form-select">
          <option value="">Select...</option>
          <option value="MALE">Male</option>
          <option value="FEMALE">Female</option>
          <option value="OTHER">Other</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Address</label>
        <textarea formControlName="address" rows="2" class="form-control"></textarea>
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button type="submit" class="btn btn-success d-flex align-items-center" [disabled]="saving">
          <span class="material-icons me-1">save</span>
          <span>Save</span>
        </button>
        <button type="button" class="btn btn-secondary d-flex align-items-center" (click)="cancelEdit()">
          <span class="material-icons me-1">close</span>
          <span>Cancel</span>
        </button>
      </div>
    </form>

    <!-- Collapsible Change Password Panel -->
    <div class="pwd-wrap" [class.open]="showPwdPanel">
      <div class="pwd-card shadow-sm">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="m-0 fw-bold d-flex align-items-center">
            <span class="material-icons me-1"></span>
            <span>Update Password</span>
          </h6>
          <button class="btn btn-link text-muted p-0" (click)="togglePwdPanel()">Hide</button>
        </div>

        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Current Password</label>
            <input type="password" formControlName="currentPassword" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">New Password</label>
            <input type="password" formControlName="newPassword" class="form-control" />
            <small class="text-muted">Minimum 6 characters.</small>
          </div>
          <div class="col-md-4">
            <label class="form-label">Confirm New Password</label>
            <input type="password" formControlName="confirmNewPassword" class="form-control" />
            <small *ngIf="passwordForm.errors?.['passwordsMismatch'] && passwordForm.touched" class="text-danger">
              Passwords do not match.
            </small>
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-gradient d-flex align-items-center" type="submit" [disabled]="pwdSaving">
              <span class="material-icons me-1">done_all</span>
              <span>Update Password</span>
            </button>
            <button type="button" class="btn btn-outline-secondary d-flex align-items-center" (click)="togglePwdPanel()">
              <span class="material-icons me-1">close</span>
              <span>Cancel</span>
            </button>
          </div>

          <div *ngIf="pwdMsg" class="col-12 mt-1">
            <div class="alert py-2"
                 [ngClass]="{'alert-success': pwdMsg.startsWith('✅'), 'alert-danger': pwdMsg.startsWith('❌')}">
              {{ pwdMsg }}
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
